Your **HPA shows `<unknown>` CPU usage** because Kubernetes **cannot calculate CPU metrics**.
This happens when:

---

# âœ… **Root Cause**

### â— Metrics Server is NOT installed in your cluster

HPA depends on resource metrics to calculate CPU usage.
If metrics server is missing, HPA shows:

```
cpu: <unknown>/70%
```

---

# âœ… **Solution: Install Metrics Server in K3s (DigitalOcean VPS)**

Since you are running **k3s**, installing metrics server is VERY EASY.

### âœ” K3s already includes metrics-serverâ€”but it is disabled by default

We just need to ENABLE it.

---

# ğŸ”§ **Step 1: Enable Metrics Server in k3s**

Run this on your VPS:

```bash
sudo mkdir -p /etc/rancher/k3s
sudo nano /etc/rancher/k3s/config.yaml
```

Add this:

```yaml
kubelet-arg:
  - "authentication-token-webhook=true"
  - "authorization-mode=Webhook"
```

Then restart k3s:

```bash
sudo systemctl restart k3s
```

---

# ğŸ”§ **Step 2: Install Metrics Server manually (if needed)**

Run this:

```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

---

# ğŸ”§ **Step 3: Patch Metrics Server (required in cloud VPS)**

Most VPS have no internal API cert â†’ need insecure TLS:

```
kubectl patch deployment metrics-server -n kube-system \
  --type='json' \
  -p='[{
    "op": "add",
    "path": "/spec/template/spec/containers/0/args/-",
    "value": "--kubelet-insecure-tls"
  }]'
```

---

# ğŸ”§ **Step 4: Verify Metrics Server is working**

### Check pods:

```bash
kubectl get pods -n kube-system
```

You should see:

```
metrics-server-xxxxx Running
```

### Check metrics:

```bash
kubectl top nodes
kubectl top pods
```

If you get CPU/MEM numbers, it works!

---

# ğŸ”§ **Step 5: Check HPA again**

```bash
kubectl get hpa
```

You will now see:

```
cpu: 20%/70%
```

Not `<unknown>` anymore.

---

# ğŸ¯ **Summary**

| Issue                        | Reason                 | Fix                              |
| ---------------------------- | ---------------------- | -------------------------------- |
| HPA shows `<unknown>`        | Metrics Server missing | Install + patch metrics server   |
| HPA cannot autoscale         | No CPU metrics         | Enable metrics-server in k3s     |
| Node/Pod metrics not showing | Same root cause        | kubectl top pods works after fix |

---

# â¤ï¸ If you want, I can also

âœ” Install metrics-server for you
âœ” Patch and verify
âœ” Enable autoscaling
âœ” Add resource limits to your pods

Just tell me:

**"Install metrics server step-by-step"**



Great â€” your **metrics-server is working** (because `kubectl top nodes` and `kubectl top pods` show values).
So the node and pod metrics are fine.

But your **HPA is still showing `<unknown>`**:

```
cpu: <unknown>/70%
```

This happens for **one remaining reason**:

---

# âœ… **Root Cause: Your Deployment has NO CPU requests**

HPA requires **resource requests** to calculate CPU percentage.

Your deployment YAML currently has **no CPU or memory requests**:

```yaml
resources:
  requests:
    cpu:
    memory:
```

So HPA cannot know:

âœ” how much CPU the pod â€œrequestsâ€
âœ” how much percentage is used

Therefore it stays `<unknown>`.

---

# âœ… **Solution: Add resource requests & limits**

Update your deployment:

### ğŸ”§ Edit: `/www/wwwroot/CITSNVN/icsQuizUserService/icsquiz-user-app.yml`

Add this under the container:

```yaml
resources:
  requests:
    cpu: "100m"
    memory: "256Mi"
  limits:
    cpu: "300m"
    memory: "512Mi"
```

Full sample:

```yaml
containers:
  - name: icsquiz-user-app
    image: icsquiz-user-app:latest
    ports:
      - containerPort: 3090
    envFrom:
      - configMapRef:
          name: global-config
    env:
      - name: SERVER_PORT
        value: "3090"

    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "300m"
        memory: "512Mi"
```

---

# âœ… Apply changes:

```
kubectl apply -f /www/wwwroot/CITSNVN/icsQuizUserService/icsquiz-user-app.yml
```

Then check HPA:

```
kubectl get hpa
```

You will now see:

```
cpu: 25%/70%
```

---

# ğŸ”¥ Why this works

HPA cannot calculate:

```
CPU used / CPU requested
```

Example:

* Pod uses: **20m**
* Pod requests: **100m**

CPU% = 20%

Without "requests:" HPA has no base value â†’ `<unknown>`.

---

# âœ… After adding requests, your autoscaler will work properly.

If you want, I can:

âœ” update your YAML fully
âœ” update Jenkins pipeline to patch deployment automatically
âœ” tune CPU/memory requests based on real usage

Just tell me **"update YAML fully"**.









